var f={Note:"Note",Rest:"Rest",Octave:"Octave",OctaveShift:"OctaveShift",NoteLength:"NoteLength",NoteVelocity:"NoteVelocity",NoteQuantize:"NoteQuantize",Tempo:"Tempo",InfiniteLoop:"InfiniteLoop",LoopBegin:"LoopBegin",LoopExit:"LoopExit",LoopEnd:"LoopEnd"},_={tempo:120,octave:4,length:4,velocity:100,quantize:75,loopCount:2},y=function(){function r(t,e){for(var n=0;n<e.length;n++){var a=e[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(t,e,n){return e&&r(t.prototype,e),n&&r(t,n),t}}();function x(r,t){if(!(r instanceof t))throw new TypeError("Cannot call a class as a function")}var k=function(){function r(t){x(this,r),this.source=t,this.index=0}return y(r,[{key:"hasNext",value:function(){return this.index<this.source.length}},{key:"peek",value:function(){return this.source.charAt(this.index)||""}},{key:"next",value:function(){return this.source.charAt(this.index++)||""}},{key:"forward",value:function(){for(;this.hasNext()&&this.match(/\s/);)this.index+=1}},{key:"match",value:function(e){return e instanceof RegExp?e.test(this.peek()):this.peek()===e}},{key:"expect",value:function(e){this.match(e)||this.throwUnexpectedToken(),this.index+=1}},{key:"scan",value:function(e){var n=this.source.substr(this.index),a=null;if(e instanceof RegExp){var i=e.exec(n);i&&i.index===0&&(a=i[0])}else n.substr(0,e.length)===e&&(a=e);return a&&(this.index+=a.length),a}},{key:"throwUnexpectedToken",value:function(){var e=this.peek()||"ILLEGAL";throw new SyntaxError("Unexpected token: "+e)}}]),r}(),m=k,g=function(){function r(t,e){for(var n=0;n<e.length;n++){var a=e[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(t,e,n){return e&&r(t.prototype,e),n&&r(t,n),t}}();function N(r,t){if(!(r instanceof t))throw new TypeError("Cannot call a class as a function")}var u=f,L=m,b={c:0,d:2,e:4,f:5,g:7,a:9,b:11},I=function(){function r(t){N(this,r),this.scanner=new L(t)}return g(r,[{key:"parse",value:function(){var e=this,n=[];return this._readUntil(";",function(){n=n.concat(e.advance())}),n}},{key:"advance",value:function(){switch(this.scanner.peek()){case"c":case"d":case"e":case"f":case"g":case"a":case"b":return this.readNote();case"[":return this.readChord();case"r":return this.readRest();case"o":return this.readOctave();case">":return this.readOctaveShift(1);case"<":return this.readOctaveShift(-1);case"l":return this.readNoteLength();case"q":return this.readNoteQuantize();case"v":return this.readNoteVelocity();case"t":return this.readTempo();case"$":return this.readInfiniteLoop();case"/":return this.readLoop()}this.scanner.throwUnexpectedToken()}},{key:"readNote",value:function(){return{type:u.Note,noteNumbers:[this._readNoteNumber(0)],noteLength:this._readLength()}}},{key:"readChord",value:function(){var e=this;this.scanner.expect("[");var n=[],a=0;return this._readUntil("]",function(){switch(e.scanner.peek()){case"c":case"d":case"e":case"f":case"g":case"a":case"b":n.push(e._readNoteNumber(a));break;case">":e.scanner.next(),a+=12;break;case"<":e.scanner.next(),a-=12;break;default:e.scanner.throwUnexpectedToken()}}),this.scanner.expect("]"),{type:u.Note,noteNumbers:n,noteLength:this._readLength()}}},{key:"readRest",value:function(){return this.scanner.expect("r"),{type:u.Rest,noteLength:this._readLength()}}},{key:"readOctave",value:function(){return this.scanner.expect("o"),{type:u.Octave,value:this._readArgument(/\d+/)}}},{key:"readOctaveShift",value:function(e){return this.scanner.expect(/<|>/),{type:u.OctaveShift,direction:e|0,value:this._readArgument(/\d+/)}}},{key:"readNoteLength",value:function(){return this.scanner.expect("l"),{type:u.NoteLength,noteLength:this._readLength()}}},{key:"readNoteQuantize",value:function(){return this.scanner.expect("q"),{type:u.NoteQuantize,value:this._readArgument(/\d+/)}}},{key:"readNoteVelocity",value:function(){return this.scanner.expect("v"),{type:u.NoteVelocity,value:this._readArgument(/\d+/)}}},{key:"readTempo",value:function(){return this.scanner.expect("t"),{type:u.Tempo,value:this._readArgument(/\d+(\.\d+)?/)}}},{key:"readInfiniteLoop",value:function(){return this.scanner.expect("$"),{type:u.InfiniteLoop}}},{key:"readLoop",value:function(){var e=this;this.scanner.expect("/"),this.scanner.expect(":");var n={type:u.LoopBegin},a={type:u.LoopEnd},i=[];return i=i.concat(n),this._readUntil(/[|:]/,function(){i=i.concat(e.advance())}),i=i.concat(this._readLoopExit()),this.scanner.expect(":"),this.scanner.expect("/"),n.value=this._readArgument(/\d+/)||null,i=i.concat(a),i}},{key:"_readUntil",value:function(e,n){for(;this.scanner.hasNext()&&(this.scanner.forward(),!(!this.scanner.hasNext()||this.scanner.match(e)));)n()}},{key:"_readArgument",value:function(e){var n=this.scanner.scan(e);return n!==null?+n:null}},{key:"_readNoteNumber",value:function(e){var n=b[this.scanner.next()];return n+this._readAccidental()+e}},{key:"_readAccidental",value:function(){return this.scanner.match("+")?1*this.scanner.scan(/\++/).length:this.scanner.match("-")?-1*this.scanner.scan(/\-+/).length:0}},{key:"_readDot",value:function(){for(var e=(this.scanner.scan(/\.+/)||"").length,n=new Array(e),a=0;a<e;a++)n[a]=0;return n}},{key:"_readLength",value:function(){var e=[];e=e.concat(this._readArgument(/\d+/)),e=e.concat(this._readDot());var n=this._readTie();return n&&(e=e.concat(n)),e}},{key:"_readTie",value:function(){return this.scanner.forward(),this.scanner.match("^")?(this.scanner.next(),this._readLength()):null}},{key:"_readLoopExit",value:function(){var e=this,n=[];if(this.scanner.match("|")){this.scanner.next();var a={type:u.LoopExit};n=n.concat(a),this._readUntil(":",function(){n=n.concat(e.advance())})}return n}}]),r}(),w=I,T=function(){function r(t,e){for(var n=0;n<e.length;n++){var a=e[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(t,e,n){return e&&r(t.prototype,e),n&&r(t,n),t}}();function O(r,t){if(!(r instanceof t))throw new TypeError("Cannot call a class as a function")}var o=f,s=_,S=w,E=typeof Symbol!="undefined"?Symbol.iterator:"@@iterator",A=function(){function r(t){O(this,r),this.source=t,this._commands=new S(t).parse(),this._commandIndex=0,this._processedTime=0,this._iterator=null,this._octave=s.octave,this._noteLength=[s.length],this._velocity=s.velocity,this._quantize=s.quantize,this._tempo=s.tempo,this._infiniteLoopIndex=-1,this._loopStack=[],this._done=!1}return T(r,[{key:"hasNext",value:function(){return this._commandIndex<this._commands.length}},{key:"next",value:function(){if(this._done)return{done:!0,value:null};if(this._iterator){var e=this._iterator.next();if(!e.done)return e}var n=this._forward(!0);if(v(n))this._iterator=this[n.type](n);else return this._done=!0,{done:!1,value:{type:"end",time:this._processedTime}};return this.next()}},{key:E,value:function(){return this}},{key:"_forward",value:function(e){for(;this.hasNext()&&!v(this._commands[this._commandIndex]);){var n=this._commands[this._commandIndex++];this[n.type](n)}return e&&!this.hasNext()&&this._infiniteLoopIndex!==-1?(this._commandIndex=this._infiniteLoopIndex,this._forward(!1)):this._commands[this._commandIndex++]||{}}},{key:"_calcDuration",value:function(e){var n=this;e[0]===null&&(e=this._noteLength.concat(e.slice(1)));var a=null,i=0;return e=e.map(function(c){switch(c){case null:c=a;break;case 0:c=i*=2;break;default:a=i=c;break}var l=c!==null?c:s.length;return 60/n._tempo*(4/l)}),e.reduce(function(c,l){return c+l},0)}},{key:"_calcNoteNumber",value:function(e){return e+this._octave*12+12}},{key:o.Note,value:function(e){var n=this,a="note",i=this._processedTime,c=this._calcDuration(e.noteLength),l=e.noteNumbers.map(function(h){return n._calcNoteNumber(h)}),d=this._quantize,p=this._velocity;return this._processedTime=this._processedTime+c,C(l.map(function(h){return{type:a,time:i,duration:c,noteNumber:h,velocity:p,quantize:d}}))}},{key:o.Rest,value:function(e){var n=this._calcDuration(e.noteLength);this._processedTime=this._processedTime+n}},{key:o.Octave,value:function(e){this._octave=e.value!==null?e.value:s.octave}},{key:o.OctaveShift,value:function(e){var n=e.value!==null?e.value:1;this._octave+=n*e.direction}},{key:o.NoteLength,value:function(e){var n=e.noteLength.map(function(a){return a!==null?a:s.length});this._noteLength=n}},{key:o.NoteVelocity,value:function(e){this._velocity=e.value!==null?e.value:s.velocity}},{key:o.NoteQuantize,value:function(e){this._quantize=e.value!==null?e.value:s.quantize}},{key:o.Tempo,value:function(e){this._tempo=e.value!==null?e.value:s.tempo}},{key:o.InfiniteLoop,value:function(){this._infiniteLoopIndex=this._commandIndex}},{key:o.LoopBegin,value:function(e){var n=e.value!==null?e.value:s.loopCount,a=this._commandIndex,i=-1;this._loopStack.push({loopCount:n,loopTopIndex:a,loopOutIndex:i})}},{key:o.LoopExit,value:function(){var e=this._loopStack[this._loopStack.length-1],n=this._commandIndex;e.loopCount<=1&&e.loopOutIndex!==-1&&(n=e.loopOutIndex),this._commandIndex=n}},{key:o.LoopEnd,value:function(){var e=this._loopStack[this._loopStack.length-1],n=this._commandIndex;e.loopOutIndex===-1&&(e.loopOutIndex=this._commandIndex),e.loopCount-=1,0<e.loopCount?n=e.loopTopIndex:this._loopStack.pop(),this._commandIndex=n}}]),r}();function C(r){var t=0;return{next:function(){return t<r.length?{done:!1,value:r[t++]}:{done:!0}}}}function v(r){return r.type===o.Note||r.type===o.Rest}var z=A,M=z;export{M as l};
